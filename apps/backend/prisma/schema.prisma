// Nethaji Empowerment Initiative - Database Schema
// PostgreSQL with Neon serverless database

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// ENUMS
// ============================================================================

enum UserRole {
  admin
  teacher
  student
  parent
}

enum ActivityType {
  sports
  chess
  yoga
  meditation
  strength_training
}

enum AssessmentCategory {
  physical
  mental
  behavioral
  academic
}

enum ApprovalStatus {
  pending
  approved
  disbursed
  rejected
}

enum NotificationType {
  push
  sms
  email
  whatsapp
}

enum SyncStatus {
  pending
  synced
  failed
  conflict
}

enum EmploymentType {
  part_time
  full_time
}

enum Gender {
  male
  female
  other
}

enum BadgeType {
  attendance
  skill
  leadership
}

enum Rarity {
  common
  rare
  epic
  legendary
}

enum ContentType {
  video
  audio
  text
  diagram
}

enum DifficultyLevel {
  beginner
  intermediate
  advanced
}

enum ChallengeType {
  activity
  assessment
  social
}

enum ChallengeStatus {
  in_progress
  completed
  failed
}

// ============================================================================
// CORE ENTITIES
// ============================================================================

model User {
  id            String    @id @default(uuid())
  phone         String    @unique
  email         String?   @unique
  passwordHash  String    @map("password_hash")
  role          UserRole
  fullName      String    @map("full_name")
  language      String    @default("en") // en, ta, hi
  villageId     String?   @map("village_id")
  isActive      Boolean   @default(true) @map("is_active")
  lastLogin     DateTime? @map("last_login")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  // Relations
  village       Village?  @relation(fields: [villageId], references: [id])
  student       Student?
  teacher       Teacher?
  parent        Parent?
  notifications Notification[]
  syncQueue     SyncQueue[]
  auditLogs     AuditLog[]

  @@index([phone])
  @@index([email])
  @@index([role])
  @@index([villageId])
  @@index([isActive])
  @@map("users")
}

model Village {
  id              String   @id @default(uuid())
  name            String
  district        String
  state           String
  latitude        Decimal? @db.Decimal(10, 8)
  longitude       Decimal? @db.Decimal(11, 8)
  geofenceRadius  Int      @default(100) @map("geofence_radius") // meters
  createdAt       DateTime @default(now()) @map("created_at")

  // Relations
  users   User[]
  squads  Squad[]

  @@index([name])
  @@index([district])
  @@index([state])
  @@map("villages")
}

model Student {
  id                 String    @id @default(uuid())
  userId             String    @unique @map("user_id")
  dob                DateTime  @db.Date
  gender             Gender
  enrollmentDate     DateTime  @map("enrollment_date") @db.Date
  assignedTeacherId  String?   @map("assigned_teacher_id")
  squadId            String?   @map("squad_id")
  streakCount        Int       @default(0) @map("streak_count")
  totalHours         Decimal   @default(0) @map("total_hours") @db.Decimal(10, 2)
  savingsBalance     Decimal   @default(0) @map("savings_balance") @db.Decimal(10, 2)
  gamificationPoints Int       @default(0) @map("gamification_points")
  level              Int       @default(1)
  parentPhone        String?   @map("parent_phone")
  schoolName         String?   @map("school_name")
  emergencyContact   String?   @map("emergency_contact")
  medicalNotes       String?   @map("medical_notes") @db.Text
  profilePhotoUrl    String?   @map("profile_photo_url")
  isDropout          Boolean   @default(false) @map("is_dropout")
  dropoutDate        DateTime? @map("dropout_date") @db.Date
  createdAt          DateTime  @default(now()) @map("created_at")
  updatedAt          DateTime  @updatedAt @map("updated_at")

  // Relations
  user                 User                   @relation(fields: [userId], references: [id])
  assignedTeacher      Teacher?               @relation(fields: [assignedTeacherId], references: [id])
  squad                Squad?                 @relation(fields: [squadId], references: [id])
  attendance           Attendance[]
  assessments          Assessment[]
  incentives           Incentive[]
  studentBadges        StudentBadge[]
  studentParents       StudentParent[]
  activityDownloads    StudentActivityDownload[]
  challenges           StudentChallenge[]

  @@index([userId])
  @@index([assignedTeacherId])
  @@index([squadId])
  @@index([enrollmentDate])
  @@index([isDropout])
  @@map("students")
}

model Teacher {
  id                    String         @id @default(uuid())
  userId                String         @unique @map("user_id")
  hireDate              DateTime       @map("hire_date") @db.Date
  employmentType        EmploymentType @map("employment_type")
  performanceScore      Decimal        @default(0) @map("performance_score") @db.Decimal(5, 2)
  bonusEligible         Boolean        @default(false) @map("bonus_eligible")
  totalStudentsManaged  Int            @default(0) @map("total_students_managed")
  activeStudentsCount   Int            @default(0) @map("active_students_count")
  specialization        String?
  certification         String?        @db.Text
  bankAccount           String?        @map("bank_account")
  ifscCode              String?        @map("ifsc_code")
  monthlySalary         Decimal        @default(0) @map("monthly_salary") @db.Decimal(10, 2)
  lastBonusDate         DateTime?      @map("last_bonus_date") @db.Date
  profilePhotoUrl       String?        @map("profile_photo_url")
  createdAt             DateTime       @default(now()) @map("created_at")
  updatedAt             DateTime       @updatedAt @map("updated_at")

  // Relations
  user                  User                    @relation(fields: [userId], references: [id])
  assignedStudents      Student[]
  attendance            Attendance[]
  assessments           Assessment[]
  performanceLogs       TeacherPerformanceLog[]

  @@index([userId])
  @@index([hireDate])
  @@index([performanceScore])
  @@index([bonusEligible])
  @@map("teachers")
}

model Parent {
  id              String    @id @default(uuid())
  userId          String?   @unique @map("user_id") // Optional - parent may not have app account
  phone           String    @unique
  fullName        String    @map("full_name")
  relationship    String    // father, mother, guardian
  whatsappEnabled Boolean   @default(false) @map("whatsapp_enabled")
  smsEnabled      Boolean   @default(true) @map("sms_enabled")
  language        String    @default("en")
  createdAt       DateTime  @default(now()) @map("created_at")

  // Relations
  user            User?           @relation(fields: [userId], references: [id])
  studentParents  StudentParent[]
  notifications   Notification[]

  @@index([phone])
  @@index([userId])
  @@map("parents")
}

model StudentParent {
  id         String   @id @default(uuid())
  studentId  String   @map("student_id")
  parentId   String   @map("parent_id")
  isPrimary  Boolean  @default(false) @map("is_primary")
  createdAt  DateTime @default(now()) @map("created_at")

  // Relations
  student Student @relation(fields: [studentId], references: [id])
  parent  Parent  @relation(fields: [parentId], references: [id])

  @@index([studentId])
  @@index([parentId])
  @@map("student_parents")
}

model Squad {
  id               String   @id @default(uuid())
  name             String
  villageId        String   @map("village_id")
  captainStudentId String?  @map("captain_student_id")
  totalPoints      Int      @default(0) @map("total_points")
  createdAt        DateTime @default(now()) @map("created_at")

  // Relations
  village  Village   @relation(fields: [villageId], references: [id])
  students Student[]

  @@index([villageId])
  @@index([captainStudentId])
  @@map("squads")
}

// ============================================================================
// ACTIVITY TRACKING
// ============================================================================

model Attendance {
  id            String       @id @default(uuid())
  studentId     String       @map("student_id")
  teacherId     String       @map("teacher_id")
  date          DateTime     @db.Date
  activityType  ActivityType @map("activity_type")
  hours         Decimal      @db.Decimal(4, 2)
  checkInTime   DateTime     @map("check_in_time")
  checkOutTime  DateTime?    @map("check_out_time")
  latitude      Decimal?     @db.Decimal(10, 8)
  longitude     Decimal?     @db.Decimal(11, 8)
  photoUrl      String?      @map("photo_url")
  notes         String?      @db.Text
  syncStatus    SyncStatus   @default(synced) @map("sync_status")
  offlineId     String?      @map("offline_id") // Client-side temp ID for offline sync
  createdAt     DateTime     @default(now()) @map("created_at")
  updatedAt     DateTime     @updatedAt @map("updated_at")

  // Relations
  student Student @relation(fields: [studentId], references: [id])
  teacher Teacher @relation(fields: [teacherId], references: [id])

  @@unique([studentId, date, activityType])
  @@index([studentId])
  @@index([teacherId])
  @@index([date])
  @@index([activityType])
  @@index([syncStatus])
  @@map("attendance")
}

model Assessment {
  id             String             @id @default(uuid())
  studentId      String             @map("student_id")
  teacherId      String             @map("teacher_id")
  assessmentDate DateTime           @map("assessment_date") @db.Date
  category       AssessmentCategory
  metric         String             // height, weight, chess_rating, etc.
  value          String             // Stored as string to handle different types
  unit           String?            // cm, kg, rating, etc.
  notes          String?            @db.Text
  createdAt      DateTime           @default(now()) @map("created_at")

  // Relations
  student Student @relation(fields: [studentId], references: [id])
  teacher Teacher @relation(fields: [teacherId], references: [id])

  @@index([studentId])
  @@index([teacherId])
  @@index([assessmentDate])
  @@index([category])
  @@index([metric])
  @@map("assessments")
}

model Incentive {
  id                 String         @id @default(uuid())
  studentId          String         @map("student_id")
  milestoneType      String         @map("milestone_type") // 16_week_streak, etc.
  amount             Decimal        @db.Decimal(10, 2)
  weeksCompleted     Int            @map("weeks_completed")
  approvalStatus     ApprovalStatus @default(pending) @map("approval_status")
  approvedBy         String?        @map("approved_by")
  approvedDate       DateTime?      @map("approved_date")
  disbursedDate      DateTime?      @map("disbursed_date")
  disbursementMethod String?        @map("disbursement_method")
  transactionId      String?        @map("transaction_id")
  notes              String?        @db.Text
  createdAt          DateTime       @default(now()) @map("created_at")

  // Relations
  student Student @relation(fields: [studentId], references: [id])

  @@index([studentId])
  @@index([approvalStatus])
  @@index([approvedDate])
  @@index([disbursedDate])
  @@map("incentives")
}

// ============================================================================
// GAMIFICATION
// ============================================================================

model Badge {
  id           String      @id @default(uuid())
  name         String
  description  String      @db.Text
  iconUrl      String?     @map("icon_url")
  badgeType    BadgeType   @map("badge_type")
  criteria     Json        // Unlock conditions as JSON
  pointsValue  Int         @default(0) @map("points_value")
  rarity       Rarity      @default(common)
  createdAt    DateTime    @default(now()) @map("created_at")

  // Relations
  studentBadges StudentBadge[]

  @@index([badgeType])
  @@index([rarity])
  @@map("badges")
}

model StudentBadge {
  id         String   @id @default(uuid())
  studentId  String   @map("student_id")
  badgeId    String   @map("badge_id")
  earnedDate DateTime @default(now()) @map("earned_date")
  notified   Boolean  @default(false)

  // Relations
  student Student @relation(fields: [studentId], references: [id])
  badge   Badge   @relation(fields: [badgeId], references: [id])

  @@unique([studentId, badgeId])
  @@index([studentId])
  @@index([badgeId])
  @@index([earnedDate])
  @@map("student_badges")
}

model DailyChallenge {
  id            String          @id @default(uuid())
  title         String
  description   String          @db.Text
  challengeType ChallengeType   @map("challenge_type")
  targetValue   String          @map("target_value") // "20 pushups", "1 hour chess"
  pointsReward  Int             @default(0) @map("points_reward")
  startDate     DateTime        @db.Date @map("start_date")
  endDate       DateTime        @db.Date @map("end_date")
  isActive      Boolean         @default(true) @map("is_active")
  createdAt     DateTime        @default(now()) @map("created_at")

  // Relations
  studentChallenges StudentChallenge[]

  @@index([challengeType])
  @@index([startDate])
  @@index([endDate])
  @@index([isActive])
  @@map("daily_challenges")
}

model StudentChallenge {
  id           String          @id @default(uuid())
  studentId    String          @map("student_id")
  challengeId  String          @map("challenge_id")
  status       ChallengeStatus @default(in_progress)
  progress     String?         // Current progress description
  completedAt  DateTime?       @map("completed_at")
  pointsEarned Int             @default(0) @map("points_earned")

  // Relations
  student   Student        @relation(fields: [studentId], references: [id])
  challenge DailyChallenge @relation(fields: [challengeId], references: [id])

  @@index([studentId])
  @@index([challengeId])
  @@index([status])
  @@map("student_challenges")
}

// ============================================================================
// CONTENT MANAGEMENT
// ============================================================================

model Activity {
  id              String          @id @default(uuid())
  type            ContentType
  category        String          // exercise, chess, yoga, meditation, health
  title           String
  description     String?         @db.Text
  contentUrl      String?         @map("content_url")
  thumbnailUrl    String?         @map("thumbnail_url")
  durationMinutes Int?            @map("duration_minutes")
  fileSizeMb      Decimal?        @map("file_size_mb") @db.Decimal(8, 2)
  language        String
  difficultyLevel DifficultyLevel @default(beginner) @map("difficulty_level")
  isPremium       Boolean         @default(false) @map("is_premium")
  downloadCount   Int             @default(0) @map("download_count")
  createdAt       DateTime        @default(now()) @map("created_at")
  updatedAt       DateTime        @updatedAt @map("updated_at")

  // Relations
  studentDownloads StudentActivityDownload[]

  @@index([type])
  @@index([category])
  @@index([language])
  @@index([difficultyLevel])
  @@index([isPremium])
  @@map("activities")
}

model StudentActivityDownload {
  id           String    @id @default(uuid())
  studentId    String    @map("student_id")
  activityId   String    @map("activity_id")
  downloadedAt DateTime  @default(now()) @map("downloaded_at")
  lastAccessed DateTime? @map("last_accessed")

  // Relations
  student  Student  @relation(fields: [studentId], references: [id])
  activity Activity @relation(fields: [activityId], references: [id])

  @@index([studentId])
  @@index([activityId])
  @@map("student_activity_downloads")
}

// ============================================================================
// NOTIFICATIONS & COMMUNICATION
// ============================================================================

model Notification {
  id          String           @id @default(uuid())
  userId      String?          @map("user_id") // For users with accounts
  parentId    String?          @map("parent_id") // For parents via SMS
  type        NotificationType
  category    String           // attendance, achievement, payment, reminder
  title       String
  message     String           @db.Text
  data        Json?            // Extra metadata
  status      String           @default("pending") // pending, sent, failed, delivered, read
  sentAt      DateTime?        @map("sent_at")
  deliveredAt DateTime?        @map("delivered_at")
  readAt      DateTime?        @map("read_at")
  errorMessage String?         @map("error_message") @db.Text
  createdAt   DateTime         @default(now()) @map("created_at")

  // Relations
  user   User?   @relation(fields: [userId], references: [id])
  parent Parent? @relation(fields: [parentId], references: [id])

  @@index([userId])
  @@index([parentId])
  @@index([type])
  @@index([category])
  @@index([status])
  @@index([sentAt])
  @@map("notifications")
}

// ============================================================================
// SYSTEM TABLES
// ============================================================================

model SyncQueue {
  id           String     @id @default(uuid())
  userId       String     @map("user_id")
  entityType   String     @map("entity_type") // attendance, assessment, etc.
  entityId     String?    @map("entity_id") // Server ID after sync
  offlineId    String     @map("offline_id") // Client temp ID
  operation    String     // create, update, delete
  payload      Json       // Full data
  syncStatus   SyncStatus @default(pending) @map("sync_status")
  retryCount   Int        @default(0) @map("retry_count")
  errorMessage String?    @map("error_message") @db.Text
  createdAt    DateTime   @default(now()) @map("created_at")
  syncedAt     DateTime?  @map("synced_at")

  // Relations
  user User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([entityType])
  @@index([syncStatus])
  @@index([createdAt])
  @@map("sync_queue")
}

model AuditLog {
  id         String    @id @default(uuid())
  userId     String    @map("user_id")
  action     String    // approve_incentive, delete_student, etc.
  entityType String    @map("entity_type") // student, teacher, incentive, etc.
  entityId   String?   @map("entity_id")
  oldValues  Json?     @map("old_values")
  newValues  Json?     @map("new_values")
  ipAddress  String?   @map("ip_address")
  userAgent  String?   @map("user_agent") @db.Text
  timestamp  DateTime  @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([action])
  @@index([entityType])
  @@index([entityId])
  @@index([timestamp])
  @@map("audit_logs")
}

model TeacherPerformanceLog {
  id                      String   @id @default(uuid())
  teacherId               String   @map("teacher_id")
  month                   DateTime @db.Date // YYYY-MM-01 format
  attendanceCompletionRate Decimal @default(0) @map("attendance_completion_rate") @db.Decimal(5, 2)
  studentRetentionRate    Decimal  @default(0) @map("student_retention_rate") @db.Decimal(5, 2)
  activityVarietyScore    Decimal  @default(0) @map("activity_variety_score") @db.Decimal(5, 2)
  avgStudentProgress      Decimal  @default(0) @map("avg_student_progress") @db.Decimal(5, 2)
  totalHoursLogged        Decimal  @default(0) @map("total_hours_logged") @db.Decimal(10, 2)
  performanceScore        Decimal  @default(0) @map("performance_score") @db.Decimal(5, 2)
  bonusEarned             Decimal  @default(0) @map("bonus_earned") @db.Decimal(10, 2)
  notes                   String?  @db.Text
  createdAt               DateTime @default(now()) @map("created_at")

  // Relations
  teacher Teacher @relation(fields: [teacherId], references: [id])

  @@unique([teacherId, month])
  @@index([teacherId])
  @@index([month])
  @@map("teacher_performance_logs")
}
